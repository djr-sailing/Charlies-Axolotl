<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Axolotl Tamagotchi ‚Äì Starter</title>
  <style>
    :root {
      --bg: #f7f5ff;
      --card: #ffffff;
      --text: #222;
      --muted: #6b6b6b;
      --accent: #7c5cff; /* UI accent */
      --good: #4caf50;
      --warn: #ffb300;
      --bad: #ff5252;
    }
    html, body {
      height: 100%;
      margin: 0;
      background: radial-gradient(1000px 700px at 20% -10%, #ffe9f2, transparent 60%),
                  radial-gradient(800px 500px at 120% 10%, #eaf4ff, transparent 50%),
                  var(--bg);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      color: var(--text);
    }
    .wrap {
      max-width: 420px;
      margin: 0 auto;
      padding: 16px 12px 32px;
    }
    .card {
      background: var(--card);
      border-radius: 20px;
      box-shadow: 0 10px 30px rgba(50, 34, 120, .1);
      padding: 10px 10px 14px;
    }
    .topbar {
      display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;
    }
    .title {
      font-weight: 800; letter-spacing: .3px; font-size: 16px; display:flex; align-items:center; gap:8px;
    }
    .title .dot { width:10px; height:10px; border-radius:50%; background:var(--accent); }
    .controls {
      display:flex; align-items:center; gap:8px;
    }
    .controls input[type="text"] {
      width: 120px; border: 1px solid #e5e5ee; border-radius: 12px; padding: 6px 10px; outline: none;
      background:#fbfbff;
    }
    .controls input[type="color"] {
      appearance: none; border: none; width: 32px; height: 32px; background: none; padding:0;
    }
    .controls input[type="color"]::-webkit-color-swatch-wrapper { padding:0; }
    .controls input[type="color"]::-webkit-color-swatch {
      border: 2px solid #e5e5ee; border-radius: 8px;
    }
    .canvas-holder { border-radius: 16px; overflow: hidden; outline: 1px solid rgba(124,92,255,.10); }
    .bars { display:grid; grid-template-columns: 1fr; gap: 8px; margin: 12px 4px 6px;}
    .bar { background:#f2f0ff; border-radius: 999px; height: 12px; position:relative; overflow:hidden; }
    .bar span { position:absolute; left:0; top:0; bottom:0; width:50%; background:linear-gradient(90deg, #9d82ff, #ff7ad9); border-radius: 999px; transition: width .25s ease; }
    .barlabel { font-size: 12px; color: var(--muted); margin: 0 6px 2px; display:flex; justify-content:space-between;}
    .actions { display:grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; }
    .btn {
      border: none; padding: 10px 8px; border-radius: 14px; background: #f5f3ff; cursor:pointer;
      font-weight: 700; font-size: 12px; transition: transform .06s ease, background .2s;
      display:flex; flex-direction:column; align-items:center; gap:6px; box-shadow: inset 0 0 0 1px rgba(124,92,255,.15);
    }
    .btn:active { transform: translateY(1px) scale(.99); }
    .btn .emoji { font-size: 20px; }
    .hint { text-align:center; font-size: 12px; color: var(--muted); margin-top: 10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="topbar">
        <div class="title"><span class="dot"></span> Axolotl Buddy</div>
        <div class="controls">
          <input id="nameInput" type="text" placeholder="Name me‚Ä¶" />
          <input id="colorInput" type="color" value="#ffb3d9" title="Axolotl color" />
        </div>
      </div>

      <div class="canvas-holder">
        <div id="game" style="width:100%; aspect-ratio: 9/16;"></div>
      </div>

      <div class="bars">
        <div class="barlabel"><span>Hunger</span><strong id="hungerVal">‚Äî</strong></div>
        <div class="bar"><span id="hungerBar"></span></div>
        <div class="barlabel"><span>Fun</span><strong id="funVal">‚Äî</strong></div>
        <div class="bar"><span id="funBar"></span></div>
        <div class="barlabel"><span>Energy</span><strong id="energyVal">‚Äî</strong></div>
        <div class="bar"><span id="energyBar"></span></div>
        <div class="barlabel"><span>Clean</span><strong id="cleanVal">‚Äî</strong></div>
        <div class="bar"><span id="cleanBar"></span></div>
      </div>

      <div class="actions">
        <button class="btn" id="feed"><span class="emoji">üç§</span>Feed</button>
        <button class="btn" id="play"><span class="emoji">üéæ</span>Play</button>
        <button class="btn" id="sleep"><span class="emoji">üåô</span>Sleep</button>
        <button class="btn" id="clean"><span class="emoji">ü´ß</span>Clean</button>
      </div>

      <div class="hint">Tip: your buddy autosaves. Change color & name anytime.</div>
    </div>
  </div>

  <!-- Phaser 3 -->
  <script src="https://cdn.jsdelivr.net/npm/phaser@3.80.0/dist/phaser.min.js"></script>
  <script>
    /***************
     * Save/Load
     ***************/
    const STORAGE_KEY = 'axolotl_tama_v1';
    const defaultState = () => ({
      name: 'Axie',
      color: '#ffb3d9',
      stats: { hunger: 70, fun: 70, energy: 70, clean: 70 },
      lastTick: Date.now(),
      sleeping: false
    });
    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return defaultState();
        const data = JSON.parse(raw);
        return { ...defaultState(), ...data, stats: { ...defaultState().stats, ...(data.stats||{}) } };
      } catch { return defaultState(); }
    }
    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }

    let state = loadState();

    /***************
     * UI Elements
     ***************/
    const nameInput = document.getElementById('nameInput');
    const colorInput = document.getElementById('colorInput');
    const hungerBar = document.getElementById('hungerBar');
    const funBar = document.getElementById('funBar');
    const energyBar = document.getElementById('energyBar');
    const cleanBar = document.getElementById('cleanBar');
    const hungerVal = document.getElementById('hungerVal');
    const funVal = document.getElementById('funVal');
    const energyVal = document.getElementById('energyVal');
    const cleanVal = document.getElementById('cleanVal');

    nameInput.value = state.name;
    colorInput.value = state.color;

    function clamp(v){ return Math.max(0, Math.min(100, v)); }
    function setBar(el, val, labelEl){
      const pct = clamp(val);
      el.style.width = pct + '%';
      labelEl.textContent = Math.round(pct);
      // color feedback
      let bg = 'linear-gradient(90deg, #9d82ff, #ff7ad9)';
      if (pct < 30) bg = 'linear-gradient(90deg, var(--bad), #ff9aa6)';
      else if (pct < 60) bg = 'linear-gradient(90deg, var(--warn), #ffd16b)';
      else bg = 'linear-gradient(90deg, var(--good), #7dffa6)';
      el.style.background = bg;
    }
    function refreshBars() {
      setBar(hungerBar, state.stats.hunger, hungerVal);
      setBar(funBar, state.stats.fun, funVal);
      setBar(energyBar, state.stats.energy, energyVal);
      setBar(cleanBar, state.stats.clean, cleanVal);
    }
    refreshBars();

    nameInput.addEventListener('input', () => { state.name = nameInput.value || 'Axie'; saveState(); if (scene) scene.updateName(); });
    colorInput.addEventListener('input', () => { state.color = colorInput.value; saveState(); if (scene) scene.updateColor(); });

    /***************
     * Phaser Game
     ***************/
    let scene = null;

    const config = {
      type: Phaser.AUTO,
      parent: 'game',
      backgroundColor: '#f8f6ff',
      scale: {
        mode: Phaser.Scale.FIT,
        autoCenter: Phaser.Scale.CENTER_BOTH,
        width: 360,
        height: 640
      },
      scene: {
        preload, create, update
      }
    };
    const game = new Phaser.Game(config);

    function preload(){}

    // ‚úÖ FIXED: Graphics API only (no save/restore/translate/rotate)
    function drawAxolotl(g, color, w, h, blinkProgress = 1) {
      g.clear();
      const cx = w / 2, cy = h / 2 + 20;

      // water
      g.fillStyle(0xeef9ff, 1);
      g.fillRoundedRect(0, h * 0.55, w, h * 0.45, 24);

      // body
      const c = Phaser.Display.Color.HexStringToColor(color).color;
      g.fillStyle(c, 1);
      // tail, body, head
      g.fillEllipse(cx + 40, cy + 20, 120, 60);
      g.fillEllipse(cx, cy, 180, 100);
      g.fillEllipse(cx - 40, cy - 40, 120, 100);

      // gills (placed diagonally without transforms)
      g.fillStyle(0xff87c5, 1);
      for (let i = 0; i < 3; i++) {
        g.fillEllipse(cx - 95 - i * 6, cy - 60 + i * 14, 24 + i * 8, 10); // left
        g.fillEllipse(cx + 45 + i * 6,  cy - 55 + i * 14, 24 + i * 8, 10); // right
      }

      // face
      const eyeOpen = blinkProgress > 0.2;
      g.fillStyle(0x292b2e, 1);
      if (eyeOpen) {
        g.fillEllipse(cx - 60, cy - 48, 12, 16);
        g.fillEllipse(cx - 20, cy - 48, 12, 16);
      } else {
        g.fillRect(cx - 66, cy - 48, 12, 2);
        g.fillRect(cx - 26, cy - 48, 12, 2);
      }

      // blush
      g.fillStyle(0xffa2c8, 0.6);
      g.fillEllipse(cx - 80, cy - 30, 22, 12);
      g.fillEllipse(cx,       cy - 30, 22, 12);

      // mouth
      g.lineStyle(4, 0x292b2e, 1);
      const mood = moodScore();            // 0..1
      const smile = Phaser.Math.Linear(0.3, 1.0, mood);
      const mouthW = 42, mouthH = 14 * smile;
      g.beginPath();
      g.moveTo(cx - 52, cy - 20);
      g.quadraticBezierTo(cx - 52 + mouthW, cy - 20 + mouthH, cx - 52 + mouthW * 2, cy - 20);
      g.strokePath();
    }

    function moodScore(){
      // normalized 0..1
      const s = state.stats;
      return Math.max(0, Math.min(1, (s.hunger + s.fun + s.energy + s.clean)/400));
    }

    let axo, blinkTimer = 0, blinkOpen = 1;
    let titleText, nameText, zzz, bubbles;
    let waterTint;

    function create(){
      scene = this;

      // pleasant gradient background layer
      const bg = this.add.graphics();
      const w = this.scale.width, h = this.scale.height;
      bg.fillStyle(0xfdfbff, 1); bg.fillRect(0,0,w,h);

      // water tint overlay to shift with mood
      waterTint = this.add.rectangle(w/2, h*0.8, w, h*0.4, 0x9ddfff, 0.12);

      // axolotl graphics object
      axo = this.add.graphics();
      drawAxolotl(axo, state.color, w, h, 1);

      // floating idle tween
      this.tweens.add({ targets: axo, y: '-=8', yoyo: true, repeat: -1, duration: 1600, ease: 'sine.inOut' });

      // Create a bubble texture and particle manager
      const g = this.make.graphics({ x:0, y:0, add:false });
      g.fillStyle(0xffffff, 1);
      g.fillCircle(8,8,8);
      g.generateTexture('bubble', 16, 16);
      bubbles = this.add.particles('bubble');

      // Zzz text when sleeping
      zzz = this.add.text(w - 70, 70, '', { fontFamily: 'inherit', fontSize: '28px', fontStyle: '700', color: '#6a6a88' });

      // Title + name
      titleText = this.add.text(16, 14, 'Axolotl Buddy', { fontFamily: 'inherit', fontSize: '16px', fontStyle: '700', color: '#7c5cff' });
      nameText  = this.add.text(16, 36, state.name, { fontFamily: 'inherit', fontSize: '22px', fontStyle: '800', color: '#2c2c3c' });

      // Click ripple
      this.input.on('pointerdown', (p) => {
        const sp = this.add.circle(p.x, p.y, 6, 0xaadfff, 0.9);
        this.tweens.add({ targets: sp, alpha: 0, scale: 2, duration: 400, onComplete: ()=> sp.destroy() });
      });

      // Hook buttons
      document.getElementById('feed').onclick  = () => doAction('feed');
      document.getElementById('play').onclick  = () => doAction('play');
      document.getElementById('sleep').onclick = () => doAction('sleep');
      document.getElementById('clean').onclick = () => doAction('clean');

      // restore after time passed (offline progression)
      offlineProgress();

      // autosave
      this.time.addEvent({ delay: 2500, loop: true, callback: saveState });

      // stat decay tick
      this.time.addEvent({ delay: 1000, loop: true, callback: tick });

      updateMoodTint();
    }

    function update(time, delta){
      // blink cycle
      blinkTimer += delta;
      const blinkInterval = 2800 + Math.sin(time/5000)*400; // a bit organic
      if (blinkTimer > blinkInterval) { blinkOpen = 0; }
      if (blinkOpen === 0 && blinkTimer > blinkInterval + 140) { blinkOpen = 1; blinkTimer = 0; }
      drawAxolotl(axo, state.color, this.scale.width, this.scale.height, blinkOpen);
      // Zzz if sleeping
      if (state.sleeping && Math.random()<0.02){
        zzz.text += 'z';
        if (zzz.text.length>6) zzz.text = 'z';
      } else if (!state.sleeping){ zzz.text = ''; }
    }

    function updateName(){ nameText.setText(state.name); }
    function updateColor(){ /* redrawn every frame; nothing else needed */ }
    scene && (scene.updateName = updateName);
    scene && (scene.updateColor = updateColor);

    /***************
     * Game Logic
     ***************/
    function tick(){
      const s = state.stats;
      const baseDecay = state.sleeping ? 0.5 : 1.0;
      s.hunger = clamp(s.hunger - baseDecay);
      s.fun    = clamp(s.fun - (state.sleeping ? 0.3 : 0.7));
      s.clean  = clamp(s.clean - (state.sleeping ? 0.2 : 0.5));
      s.energy = clamp(s.energy + (state.sleeping ? +2.0 : -0.6));
      refreshBars();
      updateMoodTint();
      state.lastTick = Date.now();
    }

    function updateMoodTint(){
      const m = moodScore(); // 0..1
      const good = 0x9dffc7, bad = 0xffc1c1;
      const mix = Phaser.Display.Color.Interpolate.ColorWithColor(
        Phaser.Display.Color.ValueToColor(bad),
        Phaser.Display.Color.ValueToColor(good),
        100, Math.round(m*100)
      );
      const col = Phaser.Display.Color.GetColor(mix.r, mix.g, mix.b);
      waterTint.setFillStyle(col, 0.18);
      nameText.setColor(m > 0.5 ? '#2c2c3c' : '#44446a');
    }

    function pulse(){
      if (!scene) return;
      scene.tweens.add({ targets: axo, scale: 1.02, yoyo: true, duration: 140, ease: 'sine.inOut' });
    }

    let actionCooldown = false;
    function doAction(kind){
      if (actionCooldown) return;
      actionCooldown = true;
      setTimeout(()=> actionCooldown=false, 500);

      const s = state.stats;
      if (kind === 'feed'){
        s.hunger = clamp(s.hunger + 22);
        s.clean  = clamp(s.clean - 4);
        makeBubbleBurst(4);
      }
      if (kind === 'play'){
        s.fun    = clamp(s.fun + 22);
        s.energy = clamp(s.energy - 6);
        ripple();
      }
      if (kind === 'sleep'){
        state.sleeping = !state.sleeping;
        if (state.sleeping){ s.energy = clamp(s.energy + 6); }
        else { s.fun = clamp(s.fun + 6); }
        spinZzz();
      }
      if (kind === 'clean'){
        s.clean  = clamp(s.clean + 24);
        makeBubbleBurst(12);
      }
      refreshBars();
      updateMoodTint();
      pulse();
      saveState();
    }

    function ripple(){
      const w = scene.scale.width, h = scene.scale.height;
      const ring = scene.add.circle(w/2, h*0.7, 10, 0x9ddfff, 0.25);
      scene.tweens.add({ targets: ring, alpha:0, scale:4, duration: 600, ease:'sine.out', onComplete: ()=> ring.destroy() });
    }
    function makeBubbleBurst(count=8){
      const w = scene.scale.width, h = scene.scale.height;
      const emitter = bubbles.createEmitter({
        x: w/2, y: h*0.75,
        speed: {min: -70, max: 70},
        angle: {min: -110, max:-70},
        lifespan: 800,
        scale: { start: 0.8, end: 0.0 },
        gravityY: 200
      });
      emitter.explode(count, w/2, h*0.75);
      // remove emitter after use
      scene.time.delayedCall(900, () => emitter.remove());
    }
    function spinZzz(){
      scene.tweens.add({ targets: zzz, angle: '+=10', yoyo: true, duration: 200 });
    }

    function offlineProgress(){
      const now = Date.now();
      const dt = Math.max(0, now - (state.lastTick || now));
      const seconds = Math.min(8*3600, Math.floor(dt/1000)); // cap 8h
      for (let i=0;i<seconds;i++){
        const s = state.stats;
        const bd = state.sleeping ? 0.5 : 1.0;
        s.hunger = clamp(s.hunger - bd/2);
        s.fun    = clamp(s.fun - (state.sleeping ? 0.15 : 0.35));
        s.clean  = clamp(s.clean - (state.sleeping ? 0.1 : 0.25));
        s.energy = clamp(s.energy + (state.sleeping ? +1.2 : -0.3));
      }
      refreshBars();
      updateMoodTint();
      state.lastTick = now;
      saveState();
    }

    // persist on tab hide
    document.addEventListener('visibilitychange', ()=> { if (document.hidden) saveState(); });

    // expose for inputs after scene is created
    window.addEventListener('phaserCreated', () => {
      scene.updateName = updateName;
      scene.updateColor = updateColor;
    });
  </script>
</body>
</html>
